# 📌 전략 설명 프롬프트 (Cursor / 코드 에이전트용)

## 1) 전략 목표 (핵심)

이 전략은 **단타 스캘핑이 아니다**.

목표는:

- **약 30분(1800초) 앞을 보고**
- 장기 방향(상대가치)이 **명확히 유리할 때만 진입**
- **진입/유지/청산/전환(Flip)**을 전부 **같은 정책 점수(Policy Score)**로 판단
- **리스크/확률/전환비용(switch cost)**을 명시적으로 반영해 과매매를 억제

LONG/SHORT 모두 거래하지만 **진입은 드물고**, 가치가 유지되면 **의미 있는 시간 동안 보유**한다.

---

## 2) 모델링 철학

Monte Carlo EV를 “미래 예측값”으로 보지 않는다.

대신:

- MC는 **불확실성 하에서의 확률적 가치(Value) 추정기**
- 의사결정은 **절대 EV가 아니라 LONG vs SHORT의 상대가치 비교**
- 아래를 **명시적으로 벌점**으로 준다:
  - 꼬리위험(CVaR)
  - 큰 손실 확률
  - 거래/전환 비용

이렇게 해야 흔한 실패를 피한다:

> “EV가 조금 + → 과신해서 자주 진입 → 수수료/슬리피지로 서서히 사망”

---

## 3) 시간 지평 (Horizon)

- 목표 지평: **30분(≈1800초)**
- 멀티 지평 통합: **[5m, 10m, 15m, 20m, 30m]**
- 더 긴 지평에 가중치가 더 실리도록 설계(반감기 ≈ 30분)

즉, 미세한 노이즈에 반응하는 전략이 아니라 **방향성(중기) 중심**이다.

---

## 4) MC 엔진이 만드는 것 (산출물)

각 side(LONG/SHORT)에 대해 모든 지평에서 시뮬레이션을 하고 다음을 낸다.

### 지평별 통계

- `EV_h` : 비용 포함 기대수익(순수익)
- `CVaR_h` : 꼬리 손실(α% 최악 평균)
- `Var_h` : 분산
- `P_pos_h = P(net > 0)` : 수익 확률
- `P_sl_h = P(net < -SL_dyn)` : 동적 손절 기준 이하로 크게 깨질 확률

### 정책용 동적 손절 기준

- `SL_dyn`는 **변동성 기반**
- 대략 **0.5% 중심**, `[0.3%, 1.0%]` 범위로 clip
- “하드 스탑”이 아니라 **확률 제약에만 사용**한다

---

## 5) 정책 가치(Value) 정의 (가장 중요)

각 지평 `h`, side `s∈{LONG,SHORT}`에 대해:

```
Value_h(s) = EV_h(s)
             - λ_cvar * |CVaR_h(s)|
             - λ_std  * Std_h(s)
```

지평 가중 평균으로 합친다:

```
Value(s) = Σ w_h * Value_h(s)
P_pos(s) = Σ w_h * P_pos_h(s)
P_sl(s)  = Σ w_h * P_sl_h(s)
```

이 `Value(s)`가 **진입/유지/청산/전환 모두에서 쓰는 단일 정책 점수**다.

---

## 6) 진입 / 유지 / 청산 / 전환은 “같은 점수”로 결정

### 비용 정의

- `enter_cost = execution_cost`
- `switch_cost = 2 * execution_cost + impact_cost`  
  (청산+재진입 비용 + 추가 임팩트)

비용을 **정책 점수에서 직접 차감**한다.

---

### 진입 (포지션 없음)

다음 조건을 만족할 때만 진입:

- `P_pos(s) ≥ 0.52`
- `Value(s) - enter_cost > 0`
- 반대편보다 **마진이 충분히 큼**

즉:

> 30분 가치가 비용/리스크를 이길 때만 들어간다.

---

### 유지 (포지션 보유 중)

현재 side가 `cur`이면:

- 유지 조건:
  - `Value(cur) ≥ Value(other) - switch_cost`
  - 그리고 `P_pos(cur) ≥ 0.50`
  - tail-risk(예: `P_sl`)가 허용 범위

작은 일시적 악화는 허용(히스테리시스).

---

### 전환(Flip)

전환은 매우 보수적으로:

- 반대편이 진입 확률 기준 통과
- `Value(other) - switch_cost`가 현재보다 **명확히 우세**
- 이 상태가 **여러 틱 동안 지속**(flip streak)

→ 비용 때문에 잦은 방향 전환(과매매)을 막는다.

---

### 청산(Exit)

- 현재 side 가치가 여러 틱 동안 나쁨
- 또는 `P_sl(cur)`이 커짐
- 또는 emergency risk stop 트리거

---

## 7) 이 전략이 명시적으로 피하는 것

- ❌ EV만 보고 진입/청산
- ❌ 자주 뒤집기(고빈도 플립)
- ❌ 짧은 구간 μ로 방향을 “예측”하려는 것
- ❌ MC를 점추정 예측기로 오해하는 것
- ❌ 비용을 정책 로직에서 무시하는 것

---

## 8) 한 문장 요약(멘탈 모델)

> “30분 지평에서, 비용+리스크를 이기는 경우에만 거래하는 느린 확률적 가치투자자.  
> MC는 예측기가 아니라 리스크 포함 가치평가 엔진이다.”

---

## 9) 구현 제약 (코딩 시 중요)

- MC 출력은 `(n_paths, n_horizons)` 형태
- GPU(JAX/Metal) 사용, 정렬/비싼 연산 최소화
- 정책(Entry/Hold/Exit/Flip)은 **오케스트레이터에 있음**
- MC는 “추정”만 하고, 최종 결정은 정책이 한다
- 포지션 side/state는 외부 상태(self.positions 등)에 저장됨

---

## 10) 변경 원칙

- 진입을 더 쉽게 해서 거래 횟수만 늘리면 → ❌
- switch cost 없이 flip이 가능해지면 → ❌
- 진입과 청산이 서로 다른 기준을 쓰면 → ❌

- 리스크 캘리브레이션이 좋아지고
- 과신이 줄고
- 30분 관점에서 행동이 더 안정되면 → ✅
